<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Signal Distortion Measuring Device | Xiangyu Zhou </title> <meta name="author" content="Xiangyu Zhou"> <meta name="description" content="Undergraduate Graduation Design"> <meta name="keywords" content="Electrical Engineering, Communications, Embedded System, Machine Learning"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%91%A4&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://shaun-z.github.io/projects/THD_device/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Xiangyu</span> Zhou </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">Projects <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">Repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">CV </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Signal Distortion Measuring Device</h1> <p class="post-description">Undergraduate Graduation Design</p> </header> <article> <h2 id="system-performance-requirements">System performance requirements</h2> <ul> <li>$30mV$~$600mV$</li> <li>$1kHz$~$100kHz$</li> <li>The total harmonic distortion measurement error $\Delta=|THD_x-THD_o| \leq 3\%$</li> <li>Display one cycle waveform</li> <li>Displays normalized amplitude of fundamental and harmonics to <strong>5</strong>th harmonic</li> <li>The phone displays $THD x$, one cycle waveform, normalized amplitude of fundamental and harmonics.</li> </ul> <h2 id="automatic-gain-control-agc-circuit">Automatic Gain Control (AGC) Circuit</h2> <p>Automatic gain control (<strong>AGC</strong>) is a closed-loop <a href="https://en.wikipedia.org/wiki/Feedback" rel="external nofollow noopener" target="_blank">feedback</a> regulating circuit in an <a href="https://en.wikipedia.org/wiki/Amplifier" rel="external nofollow noopener" target="_blank">amplifier</a> or chain of amplifiers, the purpose of which is to maintain a suitable signal amplitude at its output, despite variation of the signal amplitude at the input. The average or peak output signal level is used to dynamically adjust the <a href="https://en.wikipedia.org/wiki/Gain_(electronics)" rel="external nofollow noopener" target="_blank">gain</a> of the amplifiers, enabling the circuit to work satisfactorily with a greater range of input signal levels. It is used in most <a href="https://en.wikipedia.org/wiki/Radio_receiver" rel="external nofollow noopener" target="_blank">radio receivers</a> to equalize the average volume (<a href="https://en.wikipedia.org/wiki/Loudness" rel="external nofollow noopener" target="_blank">loudness</a>) of different radio stations due to differences in received <a href="https://en.wikipedia.org/wiki/Signal_strength" rel="external nofollow noopener" target="_blank">signal strength</a>, as well as variations in a single station’s radio signal due to <a href="https://en.wikipedia.org/wiki/Fading" rel="external nofollow noopener" target="_blank">fading</a>. Without AGC the sound emitted from an <a href="https://en.wikipedia.org/wiki/Amplitude_modulation" rel="external nofollow noopener" target="_blank">AM</a> <a href="https://en.wikipedia.org/wiki/Radio" rel="external nofollow noopener" target="_blank">radio</a> receiver would vary to an extreme extent from a weak to a strong signal; the AGC effectively reduces the volume if the signal is strong and raises it when it is weaker. In a typical receiver the AGC feedback control signal is usually taken from the <a href="https://en.wikipedia.org/wiki/Detector_(radio)" rel="external nofollow noopener" target="_blank">detector</a> stage and applied to control the gain of the IF or RF amplifier stages.</p> <p>— From <a href="https://en.wikipedia.org/wiki/Automatic_gain_control" rel="external nofollow noopener" target="_blank">Wikipedia</a></p> <h3 id="agc-indicators">AGC Indicators</h3> <p>According to the requirement, the operating frequency range of AGC should include $1kHz$~$100kHz$ and the amplitude range should include $30mV$~$600mV$. Therefore, the test specifications of the design module are as follows:</p> <ul> <li>Input: Single frequency sine wave.</li> <li>Frequency: $1kHz$~$100kHz$ in $1kHz$ steps.</li> <li>Amplitude: $30mV$~$600mV$ per frequency point in $5mV$ steps.</li> <li>Output requirements: $Vpp = 3.3V$, $Vmin \gt 0V$, error $\lt 15\%$.</li> <li>Total 11500 points.</li> </ul> <h3 id="ad603">AD603</h3> <p><a href="https://www.analog.com/cn/products/ad603.html#product-overview" rel="external nofollow noopener" target="_blank">AD603</a> is a low-noise, voltage-controlled amplifier for radio frequency (RF) and intermediate frequency (IF) automatic gain control (AGC) systems. It offers precise pin-selectable gain ranging from $-11 dB$ to $+31 dB$ at $90 MHz$ bandwidth and $+9 dB$ to $+51 dB$ at $9 MHz$ bandwidth, and any intermediate gain range can be obtained with a single external resistor. The noise spectral density converted to input is only $1.3nV/\sqrt{Hz}$, and power consumption is $125 mW$ with the recommended $\pm 5V$ supply.</p> <p>Gain is linear in $dB$, precision calibrated, and does not vary with temperature or supply voltage. Gain is controlled by a high-impedance ($50 M\Omega$), low-bias ($200 nA$) differential input; the scaling factor is $25 mV/dB$, so a gain control voltage of only $1 V$ is required to cover the middle $40 dB$ of the gain range. $1 dB$ over- and under-range is provided regardless of the range selected. The gain control response time is less than $1 \mu s$ for a $40 dB$ change.</p> <p>The differential gain control interface allows the use of differential or single-ended positive or single-ended negative control voltages. Several of these amplifiers can be cascaded and the gain bias controlled by their gain to optimize the system signal-to-noise ratio (SNR).</p> <div class="row"> <div class="row justify-content-center"> <div class="col-sm-6 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/projects/THD_device/ad603-480.webp 480w,/assets/img/projects/THD_device/ad603-800.webp 800w,/assets/img/projects/THD_device/ad603-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/projects/THD_device/ad603.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="ad603" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <div class="caption"> $Vg$ is the voltage signal fed back from the rear stage to control the gain. </div> <h3 id="envelope-detection">Envelope detection</h3> <p>For the AGC output signal $Vo$, envelope detection is required to obtain the amplitude information.</p> <div class="row"> <div class="row justify-content-center"> <div class="col-sm-6 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/projects/THD_device/envelop_detection-480.webp 480w,/assets/img/projects/THD_device/envelop_detection-800.webp 800w,/assets/img/projects/THD_device/envelop_detection-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/projects/THD_device/envelop_detection.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="envelop" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <div class="caption"> In the circuit above, the first stage op-amp is able to acquire information about the amplitude of the input signal and apply a voltage to the capacitor $C2$, while $R3$ and $C2$ form an RC loop that is able to discharge through $R3$ when the signal amplitude drops. The rate of discharge depends on the time constant $\tau=R3\cdot C2$. </div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/projects/THD_device/tau_over-480.webp 480w,/assets/img/projects/THD_device/tau_over-800.webp 800w,/assets/img/projects/THD_device/tau_over-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/projects/THD_device/tau_over.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="tau_over" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/projects/THD_device/tau_good-480.webp 480w,/assets/img/projects/THD_device/tau_good-800.webp 800w,/assets/img/projects/THD_device/tau_good-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/projects/THD_device/tau_good.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="tau_good" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> A larget constant $\tau$ will lead to a very slow discharge. We need to set a suitable time constant $\tau$. As shown above, the green color is the AGC output signal and the blue line is the result of envelope detection. </div> <p>It is clear that the circuit accurately detects the envelope signal from the AGC output and, with the back stage feedback, oscillates for a period of time to control the output signal within a reasonable amplitude range.</p> <h3 id="operate-to-get-the-feedback-signal">Operate to get the feedback signal</h3> <p>After obtaining the amplitude of the AGC output signal, we can have a reasonable AGC control terminal signal $Vg$ by linear operation of the operational amplifier.</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/projects/THD_device/operate-480.webp 480w,/assets/img/projects/THD_device/operate-800.webp 800w,/assets/img/projects/THD_device/operate-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/projects/THD_device/operate.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="operate" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> We high-pass filter the result of the envelope detection, divide the voltage, and then seek the difference with the standard voltage reference, and feed the result back to the control pin of AD603. </div> <h3 id="add-dc-bias">Add DC bias</h3> <p>Since the analog input pins of the microcontroller have a certain input voltage range limitation, we need to add a DC bias to the AC signal output from the AGC, and a rail-to-rail op-amp OPA340 is used here.</p> <div class="row"> <div class="row justify-content-center"> <div class="col-sm-6 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/projects/THD_device/bias-480.webp 480w,/assets/img/projects/THD_device/bias-800.webp 800w,/assets/img/projects/THD_device/bias-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/projects/THD_device/bias.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="bias" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <div class="caption"> We high-pass filter the result of the envelope detection, divide the voltage, and then seek the difference with the standard voltage reference, and feed the result back to the control pin of AD603. </div> <p>The waveforms before and after adding DC bias are shown below:</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/projects/THD_device/bias_wave-480.webp 480w,/assets/img/projects/THD_device/bias_wave-800.webp 800w,/assets/img/projects/THD_device/bias_wave-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/projects/THD_device/bias_wave.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="bias_wave" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h3 id="system-diagram">System Diagram</h3> <p>We used LTspice, a free simulation tool provided by ADI, to build the simulation circuit:</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/projects/THD_device/system-480.webp 480w,/assets/img/projects/THD_device/system-800.webp 800w,/assets/img/projects/THD_device/system-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/projects/THD_device/system.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="system" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>Set the simulation type to transient response simulation with a total duration of 150ms in 1ms steps.</p> <div class="column"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/projects/THD_device/system_wave-480.webp 480w,/assets/img/projects/THD_device/system_wave-800.webp 800w,/assets/img/projects/THD_device/system_wave-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/projects/THD_device/system_wave.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="system_wave" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="caption"> The waveforms for each node. </div> </div> <div class="column"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/projects/THD_device/system_wave_detail-480.webp 480w,/assets/img/projects/THD_device/system_wave_detail-800.webp 800w,/assets/img/projects/THD_device/system_wave_detail-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/projects/THD_device/system_wave_detail.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="system_wave_detail" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="caption"> Details after stabilization. The white line is the final output. </div> </div> </article> <h2>References</h2> <div class="publications"> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Xiangyu Zhou. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>